# Configures local test source and local PowerShell repository.
parameters:
- name: sourceDir
  type: string
- name: localhostWebServerArgs
  type: string

steps:
  - pwsh: |
      $httpsCertPath = Join-Path $(Agent.TempDirectory) HttpsCert.pfx
      $httpsCertPassword = (New-Guid).ToString()
      dotnet dev-certs https --export-path $httpsCertPath --password $httpsCertPassword

      $securePassword = ConvertTo-SecureString $httpsCertPassword -AsPlainText
      Import-PfxCertificate -FilePath $httpsCertPath -Password $securePassword -CertStoreLocation Cert:\LocalMachine\Root

      Write-Host "##vso[task.setvariable variable=HttpsCert.Path;]$httpsCertPath"
      Write-Host "##vso[task.setvariable variable=HttpsCert.Password;]$httpsCertPassword"
    displayName: Create and install localhost HTTPS cert

  - pwsh: ${{ parameters.sourceDir }}\src\LocalhostWebServer\Run-LocalhostWebServer.ps1 '-CertPath $(HttpsCert.Path) -CertPassword $(HttpsCert.Password) -OutCertFile $(Agent.TempDirectory)\servercert.cer ${{ parameters.localhostWebServerArgs }}'
    displayName: Launch LocalhostWebServer

  - pwsh: ${{ parameters.sourceDir }}\src\AppInstallerCLIE2ETests\TestData\Configuration\Init-TestRepository.ps1 -Force
    displayName: Setup Local PS Repository
