# Configures local test source and local PowerShell repository.
parameters:
- name: sourceDir
  type: string
- name: localhostWebServerArgs
  type: string

steps:
  - powershell: |
      $httpsCertPath = Join-Path $(Agent.TempDirectory) HttpsCert.pfx
      $httpsCertPassword = (New-Guid).ToString()
      dotnet dev-certs https --export-path $httpsCertPath --password $httpsCertPassword

      $securePassword = ConvertTo-SecureString $httpsCertPassword -AsPlainText
      Import-PfxCertificate -FilePath $httpsCertPath -Password $securePassword -CertStoreLocation Cert:\LocalMachine\Root

      Write-Host "##vso[task.setvariable variable=HttpsCertPath;]$httpsCertPath"
      Write-Host "##vso[task.setvariable variable=HttpsCertPassword;]$httpsCertPassword"
    displayName: Create and install localhost HTTPS cert

  - powershell: ${{ parameters.sourceDir }}\src\LocalhostWebServer\Run-LocalhostWebServer.ps1 '-CertPath $(HttpsCertPath) -CertPassword $(HttpsCertPassword) -OutCertFile $(Agent.TempDirectory)\servercert.cer ${{ parameters.localhostWebServerArgs }}'
    displayName: Launch LocalhostWebServer
      arguments: 

  - task: PowerShell@2
    displayName: Setup Local PS Repository
    inputs:
      filePath: '${{ parameters.sourceDir }}\src\AppInstallerCLIE2ETests\TestData\Configuration\Init-TestRepository.ps1'
      arguments: '-Force'
      pwsh: true
